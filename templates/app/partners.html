<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partenaires et Agents</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div class="sidebar bg-violet-800 text-white w-64 fixed h-full">
            <div class="p-4 flex items-center">
                <div class="logo-icon text-2xl">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="logo-text ml-3 text-xl font-bold">CRPAY-ADMIN</div>
                <button id="toggleSidebar" class="ml-auto md:hidden">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="mt-8">
                <div class="px-4 py-2 text-violet-200 uppercase text-xs font-bold">Main</div>
                <a href="{% url 'dashboard' %}" class="flex items-center px-4 py-3 text-white bg-violet-900">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-text ml-3">Tableau de bord</span>
                </a>
                <div class="px-4 py-2 text-violet-200 uppercase text-xs font-bold">Paiements</div>
                <a href="{% url 'payments' %}" class="flex items-center px-4 py-3 text-white hover:bg-violet-700">
                    <i class="fas fa-money-bill-wave"></i>
                    <span class="nav-text ml-3">Paiements</span>
                </a>
                <a href="{% url 'analytics' %}" class="flex items-center px-4 py-3 text-white hover:bg-violet-700">
                    <i class="fas fa-chart-pie"></i>
                    <span class="nav-text ml-3">Analytics</span>
                </a>
                <div class="px-4 py-2 text-violet-200 uppercase text-xs font-bold">Management</div>
                {% if request.user.is_staff or request.user.is_superuser %}
                <a href="{% url 'partners' %}" class="flex items-center px-4 py-3 text-white bg-violet-900">
                    <i class="fas fa-handshake"></i>
                    <span class="nav-text ml-3">Partenaires et Agents</span>
                </a>
                {% endif %}
                <a href="#" class="flex items-center px-4 py-3 text-white hover:bg-violet-700">
                    <i class="fas fa-users"></i>
                    <span class="nav-text ml-3">Customers</span>
                </a>
                <div class="absolute bottom-0 w-full p-4">
                    <div class="flex items-center">
                        <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="User" class="w-10 h-10 rounded-full">
                        <div class="nav-text ml-3">
                            <div class="font-medium">{{ request.user.last_name }}  {{ request.user.first_name }} </div>
                            <div class="text-xs text-violet-200">Super Admin</div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    <!-- Main Content -->
    <div class="main-content flex-1 overflow-auto ml-64">

         <!-- Top Navigation -->
            <header class="bg-white shadow-sm">
                <div class="flex items-center justify-between px-6 py-4">
                    <div class="flex items-center">
                        <button id="mobileToggle" class="mr-4 text-gray-600 md:hidden">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="text-xl font-semibold text-gray-800">Partenaires et Agents</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <button class="text-gray-600">
                                <i class="fas fa-bell"></i>
                                <span class="absolute top-0 right-0 h-2 w-2 rounded-full bg-red-500"></span>
                            </button>
                        </div>
                        <div class="relative">
                            <button class="text-gray-600">
                                <i class="fas fa-envelope"></i>
                                <span class="absolute top-0 right-0 h-2 w-2 rounded-full bg-red-500"></span>
                            </button>
                        </div>
                        <div class="relative">
                            <input type="text" placeholder="Rerchercher" class="pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </header>

         <main class="p-6">
            <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        
            <!-- Tabs Navigation -->
            <div class="flex border-b border-gray-200 mb-8">
                <button id="partnersTab" class="tab-button active px-6 py-3 font-medium text-sm rounded-t-lg focus:outline-none bg-violet-600 text-white">
                    Partners
                </button>
                <button id="agentsTab" class="tab-button px-6 py-3 font-medium text-sm rounded-t-lg focus:outline-none bg-gray-200 text-gray-700 hover:bg-gray-300">
                    Agents
                </button>
            </div>
        
            <!-- Partners Section -->
            <div id="partnersSection" class="tab-content">
                <!-- Add Partner Form -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8 slide-up">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Ajouter un nouveau partenaire</h2>
                    <form id="addPartnerForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="partnerName" class="block text-sm font-medium text-gray-700 mb-1">Nom*</label>
                            <input type="text" id="partnerName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500">
                        </div>
                        <div>
                            <label for="brandName" class="block text-sm font-medium text-gray-700 mb-1">Enseigne*</label>
                            <input type="text" id="brandName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500">
                        </div>
                        <div>
                            <label for="partnerPhone" class="block text-sm font-medium text-gray-700 mb-1">Numero de tel*</label>
                            <input type="tel" id="partnerPhone" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500">
                        </div>
                        <div>
                            <label for="partnerAddress" class="block text-sm font-medium text-gray-700 mb-1">Adresse*</label>
                            <input type="text" id="partnerAddress" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500">
                        </div>
                        <div class="md:col-span-2">
                            <label for="partnerDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="partnerDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500"></textarea>
                        </div>
                        <div class="md:col-span-2 flex justify-end">
                            <button type="submit" class="px-4 py-2 bg-violet-600 text-white rounded-md hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:ring-offset-2 transition-colors">
                                Ajouter un nouveau partenaire
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Partners List -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-700">Liste des partenaires</h2>
                        <div class="relative">
                            <input type="text" id="partnerSearch" placeholder="Search partners..." class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Enseigne</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Numero de tel.</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adresse</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="partnersTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Partners will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="partnersPagination" class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                        <!-- Pagination will be added here -->
                    </div>
                </div>
            </div>
        
        <!-- Agents Section -->
            <div id="agentsSection" class="tab-content hidden">
                <!-- Add Agent Form -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8 slide-up">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Ajouter un nouvel agent</h2>
                    <form id="addAgentForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="agentFirstName" class="block text-sm font-medium text-gray-700 mb-1">Prénoms*</label>
                            <input type="text" id="agentFirstName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500">
                        </div>
                        <div>
                            <label for="agentLastName" class="block text-sm font-medium text-gray-700 mb-1">Nom*</label>
                            <input type="text" id="agentLastName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500">
                        </div>
                        <div>
                            <label for="agentEmail" class="block text-sm font-medium text-gray-700 mb-1">Email*</label>
                            <input type="email" id="agentEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500">
                        </div>
                        <div>
                            <label for="agentPassword" class="block text-sm font-medium text-gray-700 mb-1">Mot de passe*</label>
                            <input type="password" id="agentPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500">
                        </div>
                        <div class="md:col-span-2">
                            <label for="agentPartner" class="block text-sm font-medium text-gray-700 mb-1">Assigner à un partenaire</label>
                            <select id="agentPartner" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500">
                                <option value="">Select Partner</option>
                                <!-- Partners will be dynamically added here -->
                            </select>
                        </div>
                        <div class="md:col-span-2 flex justify-end">
                            <button type="submit" class="px-4 py-2 bg-violet-600 text-white rounded-md hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:ring-offset-2 transition-colors">
                                Add Agent
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Agents List -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-700">Liste des agents</h2>
                        <div class="relative">
                            <input type="text" id="agentSearch" placeholder="Search agents..." class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom complet</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Partenaire</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="agentsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Agents will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="agentsPagination" class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                        <!-- Pagination will be added here -->
                    </div>
                </div>
            </div>
        </div>
         </main>
       
    
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md fade-in">
            <div class="flex justify-between items-start mb-4">
                <h3 id="modalTitle" class="text-lg font-semibold text-gray-800">Confirmer Action</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p id="modalMessage" class="text-gray-600 mb-6">Êtes vous sûr d'effectuer cette action ?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelAction" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Cancel
                </button>
                <button id="confirmAction" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                    Confirm
                </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md fade-in">
            <div class="flex justify-between items-start mb-4">
                <h3 id="editModalTitle" class="text-lg font-semibold text-gray-800">Modifier</h3>
                <button id="closeEditModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="editModalContent">
                <!-- Content will be dynamically added here -->
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancelEdit" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Annuler
                </button>
                <button id="saveChanges" class="px-4 py-2 bg-violet-600 text-white rounded-md hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Appliquer les modifications
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Sample data storage
        let partners = [
            { id: 1, name: "Tech Solutions", brandName: "TechSol", phone: "1234567890", address: "123 Tech St, Silicon Valley", description: "Leading tech solutions provider" },
            { id: 2, name: "Global Logistics", brandName: "GlobLog", phone: "9876543210", address: "456 Commerce Ave, New York", description: "Worldwide logistics services" }
        ];
        
        let agents = [
            { id: 1, firstName: "John", lastName: "Doe", email: "john.doe@example.com", password: "password123", partnerId: 1 },
            { id: 2, firstName: "Jane", lastName: "Smith", email: "jane.smith@example.com", password: "password456", partnerId: 2 }
        ];
        
        // DOM Elements
        const partnersTab = document.getElementById('partnersTab');
        const agentsTab = document.getElementById('agentsTab');
        const partnersSection = document.getElementById('partnersSection');
        const agentsSection = document.getElementById('agentsSection');
        const partnersTableBody = document.getElementById('partnersTableBody');
        const agentsTableBody = document.getElementById('agentsTableBody');
        const agentPartnerSelect = document.getElementById('agentPartner');
        const confirmationModal = document.getElementById('confirmationModal');
        const editModal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const confirmAction = document.getElementById('confirmAction');
        const cancelAction = document.getElementById('cancelAction');
        const closeModal = document.getElementById('closeModal');
        const closeEditModal = document.getElementById('closeEditModal');
        const cancelEdit = document.getElementById('cancelEdit');
        const saveChanges = document.getElementById('saveChanges');
        const editModalContent = document.getElementById('editModalContent');
        const editModalTitle = document.getElementById('editModalTitle');
        
        // Current action tracking
        let currentAction = null;
        let currentItemId = null;
        let currentItemType = null;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            renderPartners();
            renderAgents();
            populatePartnerSelect();
            setupEventListeners();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            partnersTab.addEventListener('click', () => switchTab('partners'));
            agentsTab.addEventListener('click', () => switchTab('agents'));
            
            // Form submissions
            document.getElementById('addPartnerForm').addEventListener('submit', addPartner);
            document.getElementById('addAgentForm').addEventListener('submit', addAgent);
            
            // Search functionality
            document.getElementById('partnerSearch').addEventListener('input', searchPartners);
            document.getElementById('agentSearch').addEventListener('input', searchAgents);
            
            // Modal controls
            closeModal.addEventListener('click', closeConfirmationModal);
            cancelAction.addEventListener('click', closeConfirmationModal);
            confirmAction.addEventListener('click', executeAction);
            
            closeEditModal.addEventListener('click', closeEditModalWindow);
            cancelEdit.addEventListener('click', closeEditModalWindow);
            saveChanges.addEventListener('click', saveItemChanges);
        }
        
        // Tab switching
        function switchTab(tab) {
            if (tab === 'partners') {
                partnersTab.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                partnersTab.classList.add('bg-violet-600', 'text-white');
                agentsTab.classList.remove('bg-violet-600', 'text-white');
                agentsTab.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                partnersSection.classList.remove('hidden');
                agentsSection.classList.add('hidden');
            } else {
                agentsTab.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                agentsTab.classList.add('bg-violet-600', 'text-white');
                partnersTab.classList.remove('bg-violet-600', 'text-white');
                partnersTab.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                agentsSection.classList.remove('hidden');
                partnersSection.classList.add('hidden');
            }
        }
        
        // Render partners list
        function renderPartners(filteredPartners = null) {
            const data = filteredPartners || partners;
            partnersTableBody.innerHTML = '';
            
            if (data.length === 0) {
                partnersTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">No partners found</td>
                    </tr>
                `;
                return;
            }
            
            data.forEach(partner => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${partner.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${partner.brandName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${partner.phone}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${partner.address}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="editItem(${partner.id}, 'partner')" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="confirmDelete(${partner.id}, 'partner')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                partnersTableBody.appendChild(row);
            });
        }
        
        // Render agents list
        function renderAgents(filteredAgents = null) {
            const data = filteredAgents || agents;
            agentsTableBody.innerHTML = '';
            
            if (data.length === 0) {
                agentsTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">No agents found</td>
                    </tr>
                `;
                return;
            }
            
            data.forEach(agent => {
                const partner = partners.find(p => p.id === agent.partnerId);
                const partnerName = partner ? partner.name : 'Unassigned';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${agent.firstName} ${agent.lastName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${agent.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${partnerName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="editItem(${agent.id}, 'agent')" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="confirmDelete(${agent.id}, 'agent')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                agentsTableBody.appendChild(row);
            });
        }
        
        // Populate partner select dropdown
        function populatePartnerSelect() {
            agentPartnerSelect.innerHTML = '<option value="">Select Partner</option>';
            partners.forEach(partner => {
                const option = document.createElement('option');
                option.value = partner.id;
                option.textContent = partner.name;
                agentPartnerSelect.appendChild(option);
            });
        }
        
        // Add new partner
        function addPartner(e) {
            e.preventDefault();
            
            const name = document.getElementById('partnerName').value;
            const brandName = document.getElementById('brandName').value;
            const phone = document.getElementById('partnerPhone').value;
            const address = document.getElementById('partnerAddress').value;
            const description = document.getElementById('partnerDescription').value;
            
            const newPartner = {
                id: partners.length > 0 ? Math.max(...partners.map(p => p.id)) + 1 : 1,
                name,
                brandName,
                phone,
                address,
                description
            };
            
            partners.push(newPartner);
            renderPartners();
            populatePartnerSelect();
            document.getElementById('addPartnerForm').reset();
            
            // Show success message
            showToast('Partner added successfully!', 'success');
        }
        
        // Add new agent
        function addAgent(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('agentFirstName').value;
            const lastName = document.getElementById('agentLastName').value;
            const email = document.getElementById('agentEmail').value;
            const password = document.getElementById('agentPassword').value;
            const partnerId = document.getElementById('agentPartner').value;
            
            const newAgent = {
                id: agents.length > 0 ? Math.max(...agents.map(a => a.id)) + 1 : 1,
                firstName,
                lastName,
                email,
                password,
                partnerId: partnerId ? parseInt(partnerId) : null
            };
            
            agents.push(newAgent);
            renderAgents();
            document.getElementById('addAgentForm').reset();
            
            // Show success message
            showToast('Agent added successfully!', 'success');
        }
        
        // Search partners
        function searchPartners() {
            const searchTerm = document.getElementById('partnerSearch').value.toLowerCase();
            const filtered = partners.filter(partner => 
                partner.name.toLowerCase().includes(searchTerm) || 
                partner.brandName.toLowerCase().includes(searchTerm) ||
                partner.phone.toLowerCase().includes(searchTerm) ||
                partner.address.toLowerCase().includes(searchTerm)
            );
            renderPartners(filtered);
        }
        
        // Search agents
        function searchAgents() {
            const searchTerm = document.getElementById('agentSearch').value.toLowerCase();
            const filtered = agents.filter(agent => 
                agent.firstName.toLowerCase().includes(searchTerm) || 
                agent.lastName.toLowerCase().includes(searchTerm) ||
                agent.email.toLowerCase().includes(searchTerm)
            );
            renderAgents(filtered);
        }
        
        // Confirm delete action
        function confirmDelete(id, type) {
            currentAction = 'delete';
            currentItemId = id;
            currentItemType = type;
            
            const itemType = type === 'partner' ? 'partner' : 'agent';
            modalTitle.textContent = `Suuprimer ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}`;
            modalMessage.textContent = `Êtes vous sûr de vouloir supprimer ce ${itemType}? Cette action est irreversible.`;
            
            confirmationModal.classList.remove('hidden');
        }
        
        // Edit item
        function editItem(id, type) {
            currentItemId = id;
            currentItemType = type;
            
            if (type === 'partner') {
                const partner = partners.find(p => p.id === id);
                editModalTitle.textContent = 'Edit Partner';
                
                editModalContent.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label for="editPartnerName" class="block text-sm font-medium text-gray-700 mb-1">Name*</label>
                            <input type="text" id="editPartnerName" value="${partner.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="editBrandName" class="block text-sm font-medium text-gray-700 mb-1">Brand Name*</label>
                            <input type="text" id="editBrandName" value="${partner.brandName}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="editPartnerPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number*</label>
                            <input type="tel" id="editPartnerPhone" value="${partner.phone}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="editPartnerAddress" class="block text-sm font-medium text-gray-700 mb-1">Address*</label>
                            <input type="text" id="editPartnerAddress" value="${partner.address}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="editPartnerDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="editPartnerDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${partner.description || ''}</textarea>
                        </div>
                    </div>
                `;
            } else {
                const agent = agents.find(a => a.id === id);
                editModalTitle.textContent = 'Edit Agent';
                
                let partnerOptions = '<option value="">Selectionner un Partenaire</option>';
                partners.forEach(partner => {
                    const selected = partner.id === agent.partnerId ? 'selected' : '';
                    partnerOptions += `<option value="${partner.id}" ${selected}>${partner.name}</option>`;
                });
                
                editModalContent.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label for="editAgentFirstName" class="block text-sm font-medium text-gray-700 mb-1">First Name*</label>
                            <input type="text" id="editAgentFirstName" value="${agent.firstName}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="editAgentLastName" class="block text-sm font-medium text-gray-700 mb-1">Last Name*</label>
                            <input type="text" id="editAgentLastName" value="${agent.lastName}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="editAgentEmail" class="block text-sm font-medium text-gray-700 mb-1">Email*</label>
                            <input type="email" id="editAgentEmail" value="${agent.email}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="editAgentPassword" class="block text-sm font-medium text-gray-700 mb-1">Password*</label>
                            <input type="password" id="editAgentPassword" value="${agent.password}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="editAgentPartner" class="block text-sm font-medium text-gray-700 mb-1">Assign to Partner</label>
                            <select id="editAgentPartner" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                ${partnerOptions}
                            </select>
                        </div>
                    </div>
                `;
            }
            
            editModal.classList.remove('hidden');
        }
        
        // Save item changes
        function saveItemChanges() {
            if (currentItemType === 'partner') {
                const partnerIndex = partners.findIndex(p => p.id === currentItemId);
                if (partnerIndex !== -1) {
                    partners[partnerIndex] = {
                        ...partners[partnerIndex],
                        name: document.getElementById('editPartnerName').value,
                        brandName: document.getElementById('editBrandName').value,
                        phone: document.getElementById('editPartnerPhone').value,
                        address: document.getElementById('editPartnerAddress').value,
                        description: document.getElementById('editPartnerDescription').value
                    };
                    
                    renderPartners();
                    populatePartnerSelect();
                    showToast('Partenaire mis à jour avec succès !', 'success');
                }
            } else {
                const agentIndex = agents.findIndex(a => a.id === currentItemId);
                if (agentIndex !== -1) {
                    agents[agentIndex] = {
                        ...agents[agentIndex],
                        firstName: document.getElementById('editAgentFirstName').value,
                        lastName: document.getElementById('editAgentLastName').value,
                        email: document.getElementById('editAgentEmail').value,
                        password: document.getElementById('editAgentPassword').value,
                        partnerId: document.getElementById('editAgentPartner').value ? parseInt(document.getElementById('editAgentPartner').value) : null
                    };
                    
                    renderAgents();
                    showToast('Agent updated successfully!', 'success');
                }
            }
            
            closeEditModalWindow();
        }
        
        // Execute action (delete)
        function executeAction() {
            if (currentAction === 'delete') {
                if (currentItemType === 'partner') {
                    // Check if any agents are assigned to this partner
                    const assignedAgents = agents.filter(a => a.partnerId === currentItemId);
                    if (assignedAgents.length > 0) {
                        showToast('Impossible de supprimer un partenaire ayant des agents assignés. Reassigner ou supprimer les agents d\'abord .', 'error');
                        closeConfirmationModal();
                        return;
                    }
                    
                    partners = partners.filter(p => p.id !== currentItemId);
                    renderPartners();
                    populatePartnerSelect();
                    showToast('Partenaire supprimé avec succès !', 'success');
                } else {
                    agents = agents.filter(a => a.id !== currentItemId);
                    renderAgents();
                    showToast('Agent supprimé avec succès !', 'success');
                }
            }
            
            closeConfirmationModal();
        }
        
        // Close confirmation modal
        function closeConfirmationModal() {
            confirmationModal.classList.add('hidden');
            currentAction = null;
            currentItemId = null;
            currentItemType = null;
        }
        
        // Close edit modal
        function closeEditModalWindow() {
            editModal.classList.add('hidden');
            currentItemId = null;
            currentItemType = null;
        }
        
        // Show toast notification
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-md shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } slide-up`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>